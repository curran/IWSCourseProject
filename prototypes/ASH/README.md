# Application State Historian (ASH)

ASH is a framework for realtime Javascript application synchronization. This means that with ASH, you can develop apps whose running instances can be shared by many people at once - when one person makes a change, that change is broadcast to all other users, maintaining synchronized application states across multi-platform clients (desktops, smartphones, tablets).

ASH has two parts, the client library and the server. The ASH server is written in Javascript using the [Node.js](http://nodejs.org/) server side Javascript runtime and the [Express](http://expressjs.com/) Web framework. The client is a Javascript library intended for use by HTML5 applications. Both sides depend on the [Socket.io Node module](http://socket.io/ "Socket.io") for realtime communication.

## Architecture
In the Model View Controller paradigm, ASH is responsible for managing the Model. Applications which use ASH must always go through the ASH API to make any changes to their Model. This is how full application model synchronization can occur.

Concepts:
 - ASH session state - A set of ASH resources. This serves as the full application state model.
 - ASH resource - An instance of an object type provided by an ASH plugin. Each resource has an ID, a type, and can have named properties assigned to it.
 - ASH plugin - An object which is responsible for managing the lifecycle of ASH resources of one particular type. ASH plugins must be registered with the ASH runtime. After a plugin is registered, it can be accessed through the ASH API within ASH transactions.
 - ASH transaction - An ordered list of ASH actions which are to be executed together atomically.
 - ASH action - A manipulation of the ASH session state. ASH actions have the following forms:
   - Set(resourceID, property, value)
     - When `property == "Type"`, the ASH plugin for that type is called upon to instantiate an ASH resource. Further Set actions are handled by the ASH resource generated by the plugin.
   - Unset(resourceID, property)
     - When `property == "Type"`, the resource is deleted. Resource deletion and cleanup is another responsibility of  ASH plugins.

## Public API
The ASH client library exports a single global variable `ASH`, which exposes the following methods:
### registerPlugin(plugin)
Args:
- `plugin` An object expected to contain the following members:
    - `type` A string Id of the resource type provided by this plugin.
    - `create(resourceId)` A factory method for creating resource instances. This function takes one argument, the Id of the resource being created. This function should have a side effect of creating a resource managed by the plugin, and should also return an object containing the following members:
        - `set(property,value)` Sets the given property to the given value on this resource.
        - `unset(property)` Unsets the given property on this resource.
    - `delete(resourceId)` A method for deleting previously created resources (really deleting, i.e. freeing memory).

### genResourceId()
Generates and returns a unique (string) resource Id.

### set(resource,property,value)
Args:
 - `resource` A string resource Id
 - `property` A string property Id.
 - `value` A string value.

If `property` is `ASH.TYPE`, then `value` is interpreted to be a type Id (as defined as `plugin.type` in a previous call to `registerPlugin(plugin)`), and setting this property causes ASH to invoke `plugin.create(resourceId)` on the plugin corresponding to the type.

If `property` is not `ASH.TYPE`, it is assumed that the property `ASH.TYPE` has been previously set, and ASH will set the property on the existing resource (meaning it will call `set()` on the object returned previously from `plugin.create()`).

### unset(resource,property)
Args:
 - `resource` A string resource Id
 - `property` A string property Id.

If `property` is `ASH.TYPE`, then unsetting this property causes ASH to invoke `plugin.delete(resourceId)` on the plugin corresponding to the type of `resource`, deleting the resource.

If `property` is not `ASH.TYPE`, ASH will unset the property on the resource (meaning it will call `unset()` on the object returned previously from `plugin.create()`).

### TYPE
The property ID used for the type property.

## Private API
Documentation and explaination of the inner workings of ASH.
### Private variables in the ASH singleton:
 - `resourceIdCounter` A counter used by `genResourceId()`
 - `plugins` The plugins registered with ASH. A map where keys are resource Ids (strings) and values are the objects passed into `registerPlugin(plugin)`
 - `resourceTypes` A resource type lookup table, can answer 'Which type is resource X?'. A map where keys are resource Ids (strings) and values are resource type Ids (strings).
 - `resources` The resources in the current ASH state.
 - 
### Concepts
 - "The ASH State" or a given ASH singleton at runtime is the current state of that ASH singleton, defined by what sequence of atomic actions have been performed.



New additions and changes in this version:

Action sequences on the server are collapsed:
 - [set a=5, set a=6] is collapsed to [set a=6]
 - [set a=5, unset a] is collapsed to []
 
 This means that when an ASH client is initialized to the state of the shared session, only the necessary actions to achieve the final state are sent from the server, cutting down tremendously on the size of the initialization message. Previously, for example, every drag of a circle was recorded to the server and sent to each client for initialization. After implementing this, only the final coordinates of dragged circles are sent.
